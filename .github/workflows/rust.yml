name: Rust

on:
  push: {}
  pull_request: {}
  workflow_dispatch: {}
  schedule:
    #       Min Hr Day Month Weekday; so this should be 1:05am each day.
    - cron: '5  1  *   *     *'

jobs:
  build_test:
    runs-on: windows-latest
    strategy:
      matrix:
        rust:
        # x86 without sse/sse2 on by default
        - { target: i586-pc-windows-msvc, toolchain: 1.51.0 }
        - { target: i586-pc-windows-msvc, toolchain: stable }
        - { target: i586-pc-windows-msvc, toolchain: beta }
        - { target: i586-pc-windows-msvc, toolchain: nightly }
        # x86
        - { target: i686-pc-windows-msvc, toolchain: 1.51.0 }
        - { target: i686-pc-windows-msvc, toolchain: stable }
        - { target: i686-pc-windows-msvc, toolchain: beta }
        - { target: i686-pc-windows-msvc, toolchain: nightly }
        # x86_64
        - { target: x86_64-pc-windows-msvc, toolchain: 1.51.0 }
        - { target: x86_64-pc-windows-msvc, toolchain: stable }
        - { target: x86_64-pc-windows-msvc, toolchain: beta }
        - { target: x86_64-pc-windows-msvc, toolchain: nightly }
    steps:
    - uses: actions/checkout@v1
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ matrix.rust.toolchain }}
        target:  ${{ matrix.rust.target }}
        profile: minimal
        default: true
    - name: suppress target-cpu=native on i586
      if: matrix.rust.target == 'i586-pc-windows-msvc'
      run: rm .cargo/config.toml
    - name: Run tests with default features
      run: cargo test --target ${{ matrix.rust.target }}
    - name: Run tests with all features
      run: cargo test --target ${{ matrix.rust.target }} --all-features

  avx512_emulated_test:
    runs-on: windows-latest
    strategy:
      matrix:
        rust:
          # - { target: x86_64-pc-windows-msvc, toolchain: 1.89.0 }
          # - { target: x86_64-pc-windows-msvc, toolchain: stable }
          - { target: x86_64-pc-windows-msvc, toolchain: nightly }
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ matrix.rust.toolchain }}
        target: ${{ matrix.rust.target }}
        profile: minimal
        default: true
    
    - name: Cache Intel SDE
      uses: actions/cache@v3
      id: cache-sde
      with:
        path: sde-external-*
        key: ${{ runner.os }}-sde-${{ env.SDE_VERSION }}

    - name: Set up environment variables
      run: |
        echo "SDE_VERSION=9.58.0" >> $env:GITHUB_ENV
        echo "SDE_DATE=2025-06-16" >> $env:GITHUB_ENV
        echo "SDE_ID=859732" >> $env:GITHUB_ENV
        echo "SDE_FILENAME=sde-external-9.58.0-2025-06-16-win.tar.xz" >> $env:GITHUB_ENV
      shell: bash

    # Only install if cache didn't hit
    - name: Install Intel SDE
      if: steps.cache-sde.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        $sdeVersion = "${{ env.SDE_VERSION }}"
        $sdeDate = "${{ env.SDE_DATE }}"
        $sdeID = "${{ env.SDE_ID }}"
        $sdeFilename = "${{ env.SDE_FILENAME }}"

        $downloadUrls = @(
          "https://downloadmirror.intel.com/${sdeID}/${sdeFilename}",
          "https://software.intel.com/content/dam/develop/external/us/en/protected/${sdeFilename}"
        )

        $downloaded = $false
        foreach ($url in $downloadUrls) {
          try {
            Write-Host "Attempting to download Intel SDE from: $url"
            $ProgressPreference = 'SilentlyContinue'
            Invoke-WebRequest -Uri $url -OutFile $sdeFilename -ErrorAction Stop
            $downloaded = $true
            break
          }
          catch {
            Write-Warning "Failed to download from ${url}: $_"
          }
        }

        if (-not $downloaded) {
          Write-Error "Download failed from all URLs"
          exit 1
        }

        # Extract
        7z x $sdeFilename -y
        $tarFile = $sdeFilename -replace '\.xz$', ''
        7z x $tarFile -y

        # Set path
        $sdeDir = Get-ChildItem -Directory -Filter "sde-external-*" | Select-Object -First 1
        echo "$($sdeDir.FullName)" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        & "$($sdeDir.FullName)\sde.exe" --version

    # Set RUSTFLAGS to enable AVX512
    - name: Set RUSTFLAGS for AVX512
      run: |
        echo "RUSTFLAGS=-C target-feature=+avx512f,+avx512dq,+avx512cd,+avx512bw,+avx512vl" >> $env:GITHUB_ENV
        echo "RUSTDOCFLAGS=-C target-feature=+avx512f,+avx512dq,+avx512cd,+avx512bw,+avx512vl" >> $env:GITHUB_ENV
      shell: powershell
    
    # Build tests with AVX512 features
    - name: Build tests with AVX512
      run: cargo test --target ${{ matrix.rust.target }} --no-run
    
    # Run tests under SDE emulation
    - name: Run tests under Intel SDE (Sapphire Rapids)
      shell: powershell
      run: |
        # Get all test executables
        $testExes = Get-ChildItem -Path "target\${{ matrix.rust.target }}\debug\deps" -Filter "*.exe" | 
                    Where-Object { $_.Name -match "^[^-]+-[a-f0-9]+\.exe$" }
        
        $failed = $false
        foreach ($exe in $testExes) {
          Write-Host "Running test: $($exe.Name)"
          & sde -spr -- $exe.FullName
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Test failed: $($exe.Name)"
            $failed = $true
          }
        }
        
        if ($failed) {
          exit 1
        }
    
    # Also run doc tests under SDE
    - name: Run doc tests under Intel SDE
      shell: powershell
      run: |
        # This is trickier as cargo doesn't directly support running doc tests through a wrapper
        # We'll need to use CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_RUNNER
        $env:CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_RUNNER = "sde -spr --"
        cargo test --target ${{ matrix.rust.target }} --doc